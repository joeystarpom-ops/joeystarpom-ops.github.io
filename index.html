<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ ‡∏¢‡∏π‡πà‡∏¢‡∏µ‡πà</title>
  <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô Mali ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Original Theme: Pink and Purple */
    body { margin: 0; font-family: 'Mali', cursive, sans-serif; background-image: url('https://i.postimg.cc/mr5PY1FR/IMG-2575.jpg'); background-size: cover; background-position: center; background-attachment: fixed; color: #4a4a4a; }
    /* Adjusted container width for better centering and spacing on larger screens */
    .container { max-width: 1200px; margin: 3rem auto; background: rgba(255, 245, 248, 0.75); border-radius: 30px; padding: 2rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); animation: fadeIn 1s ease-in-out; }
    @keyframes fadeIn { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
    h1 { text-align: center; color: #ff7b9c; font-size: 2.2rem; margin-bottom: 1.5rem; text-shadow: 3px 3px 5px rgba(255, 123, 156, 0.5); }
    .chart-wrapper { width: 100%; height: 300px; background: #fff; border-radius: 25px; padding: 1rem; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); box-sizing: border-box; }
    .anim-character { display: block; margin: 20px auto; width: 180px; animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 99999; opacity: 0; transition: opacity 0.3s ease-in-out; }
    .popup.show { display: flex; opacity: 1; }
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πâ‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Pop-up ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
    .popup-content { background: #fff; padding: 2rem; border-radius: 25px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); max-width: 500px; width: 90%; transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .popup.show .popup-content { transform: scale(1); }
    .popup-content.small { max-width: 350px; padding: 1.5rem; background: transparent; box-shadow: none; }
    .popup-content h3 { font-size: 1.5rem; margin-bottom: 1rem; color: #ff7b9c; }
    .popup-content ul { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; text-align: left; background-color: #fffafc; padding: 1rem; border-radius: 20px; }
    .popup-content li { padding: 0.5rem; border-bottom: 1px solid #f3d6e0; display: flex; justify-content: space-between; align-items: center; }
    .popup-content li:last-child { border-bottom: none; }
    .popup-content li span.date { color: #888; font-size: 0.9rem; }
    label { display: block; margin-top: 1rem; font-weight: 600; color: #b85d8c; }
    input { width: 100%; padding: 0.6rem; border: 1px solid #fbcfd9; border-radius: 18px; margin-top: 0.3rem; font-size: 1rem; background-color: #fff0f6; font-family: 'Mali', cursive, sans-serif; }
    input:focus { outline: none; box-shadow: 0 0 8px #ffaec8; background-color: #ffe5ec; }
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
    button { margin-top: 1.5rem; background-color: #ffb3ab; border: none; padding: 0.8rem 1.8rem; border-radius: 25px; font-weight: bold; cursor: pointer; color: #fff; font-size: 1rem; margin-right: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.3s ease-in-out; font-family: 'Mali', cursive, sans-serif; }
    button:hover { transform: translateY(-2px); background-color: #ffcad4; box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    button:active { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { margin-top: 2rem; width: 100%; border-collapse: collapse; background-color: #fffafc; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
    /* Increased padding and added text alignment for better readability */
    th, td { padding: 1.2rem 0.8rem; text-align: center; border-bottom: 1px solid #f3d6e0; font-size: 0.95rem; }
    th { background-color: #ffd4e3; color: #7c3a54; }
    tfoot td { background-color: #ffe5ec; font-weight: bold; font-size: 1.05rem; color: #7c3a54; text-align: left; padding: 1rem; line-height: 1.8; }
    .val-gold { color: #d4af37; }
    .val-red { color: #dc3545; }
    .val-blue { color: #007bff; }
    .val-green { color: #28a745; } /* New green color for interest paid */
    .btn-group { display: flex; justify-content: center; margin-top: 1rem; }
    .btn-group button { margin: 0 0.5rem; }
    td button { padding: 0.5rem 1rem; border-radius: 18px; font-size: 0.9rem; transition: background-color 0.2s, transform 0.2s; }
    .btn-repay { background-color: #92dff3; box-shadow: 0 4px 8px rgba(0,0,0,0.1); color: #fff; }
    .btn-repay:hover { background-color: #b3e7f5; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-interest { background-color: #ffb3ab; box-shadow: 0 4px 8px rgba(0,0,0,0.1); color: #fff; }
    .btn-interest:hover { background-color: #ffcad4; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-paid { background-color: #8ac98a; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: not-allowed; }
    .btn-paid:hover { background-color: #8ac98a; transform: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    /* New button style for partial interest payment */
    .btn-partial-paid { background-color: #c084fc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); color: #fff; }
    .btn-partial-paid:hover { background-color: #d8b4fe; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-delete { background-color: #ff6384; box-shadow: 0 4px 8px rgba(0,0,0,0.1); color: #fff; }
    .btn-delete:hover { background-color: #ff91a9; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-history { background-color: #c084fc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); color: #fff; }
    .btn-history:hover { background-color: #d8b4fe; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    /* Updated colors for better visibility */
    .row-overdue { background-color: #ffdddd; }
    .row-partial-paid { background-color: #e0d0f0; }
    /* New class for loans close to the due date */
    .row-soon-due { background-color: #FFCC99; }
    
    /* Mobile-specific styles */
    .mobile-cards { display: none; margin-top: 2rem; flex-direction: column; gap: 1.5rem; }
    .loan-card { background-color: #fffafc; padding: 1.5rem; border-radius: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); animation: slideIn 0.5s ease-out; }
    .card-overdue { background-color: #ffdddd; }
    .card-partial-paid { background-color: #e0d0f0; }
    .card-soon-due { background-color: #FFCC99; }
    @keyframes slideIn { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    .card-header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 1rem; }
    .card-header .name { font-size: 1.3rem; font-weight: bold; color: #7c3a54; }
    .card-content div { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px dashed #f3d6e0; }
    .card-content div:last-child { border-bottom: none; }
    .card-label { font-weight: 600; color: #b85d8c; }
    .card-value { text-align: right; }
    .card-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
    .card-buttons button { padding: 0.8rem; font-size: 0.9rem; margin-top: 0; }
    /* Summary for Mobile */
    .mobile-summary { display: none; margin-top: 2rem; padding: 1rem; background-color: #ffe5ec; border-radius: 20px; font-weight: bold; font-size: 1.05rem; color: #7c3a54; text-align: left; line-height: 1.8; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
    @media (max-width: 768px) {
      .container { margin: 1rem auto; padding: 1rem; }
      h1 { font-size: 1.8rem; margin-bottom: 1rem; }
      .chart-wrapper { height: 250px; }
      table { display: none; }
      tfoot { display: none; }
      .mobile-cards { display: flex; }
      .mobile-summary { display: block; }
      form label, form input, form button { font-size: 0.9rem; }
      form button { padding: 0.7rem 1.5rem; }
      .btn-group { flex-wrap: wrap; gap: 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß∏ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ ‡∏¢‡∏π‡πà‡∏¢‡∏µ‡πà üíó</h1>
    <div class="chart-wrapper">
      <canvas id="loanChart"></canvas>
    </div>
    <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExczdzZWNzbDV1a3E0ZDNpbzRxNW93Y256Z2V6NjRxZjJ3MmppMjF6eSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/DZQTp76MfXhRGOBWok/giphy.gif" class="anim-character" />

    <form id="loanForm">
      <label>‡∏ä‡∏∑‡πà‡∏≠</label>
      <input type="text" id="name" required />
      <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input type="number" id="principal" required />
      <label>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)</label>
      <input type="number" id="rate" step="0.01" required />
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏°</label>
      <input type="date" id="startDate" required />
      <button type="submit">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ</button>
      <button type="button" onclick="downloadExcel()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
      <input type="file" id="uploadFile" accept=".json" onchange="uploadData(event)" style="display:inline-block;margin-top:1rem" />
    </form>

    <table id="summaryTable">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
          <th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</th>
          <th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°</th>
          <th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</th>
          <th>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th>
          <th>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th>
          <th>‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å</th>
          <th>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</th>
          <th>‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="12" id="summaryFooter">‚Äî</td>
        </tr>
      </tfoot>
    </table>

    <!-- Mobile Cards View -->
    <div id="mobileCards" class="mobile-cards"></div>

    <!-- Mobile Summary -->
    <div id="mobileSummary" class="mobile-summary"></div>
  </div>

  <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
  <div class="popup" id="repaymentPopup">
    <div class="popup-content">
      <h3 class="text-xl font-bold mb-4 text-pink-600">‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</h3>
      <p id="repaymentMessage" class="mb-4 text-gray-600"></p>
      <input type="number" id="repaymentAmount" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" class="mb-4" />
      <div class="btn-group">
        <button onclick="submitRepayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button onclick="hidePopup('repaymentPopup')" class="bg-gray-400 shadow-md hover:bg-gray-500 hover:shadow-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ -->
  <div class="popup" id="interestPopup">
    <div class="popup-content">
      <h3 class="text-xl font-bold mb-4 text-pink-600">‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</h3>
      <p id="interestMessage" class="mb-4 text-gray-600"></p>
      <input type="number" id="interestAmount" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)" class="mb-4" />
      <div class="btn-group">
        <button onclick="submitInterestPayment()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button onclick="hidePopup('interestPopup')" class="bg-gray-400 shadow-md hover:bg-gray-500 hover:shadow-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö -->
  <div class="popup" id="deletePopup">
    <div class="popup-content">
      <h3 class="text-xl font-bold mb-4 text-red-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <p id="deleteMessage" class="mb-4 text-gray-600"></p>
      <div class="btn-group">
        <button onclick="confirmDelete()" class="bg-red-500 shadow-md hover:bg-red-600 hover:shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button onclick="hidePopup('deletePopup')" class="bg-gray-400 shadow-md hover:bg-gray-500 hover:shadow-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
  <div class="popup" id="historyPopup">
    <div class="popup-content">
      <h3 class="text-xl font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
      <ul id="historyList"></ul>
      <div class="btn-group">
        <button onclick="hidePopup('historyPopup')">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- Popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Transparent) -->
  <div class="popup" id="successPopup">
    <div class="popup-content small">
      <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExczdzZWNzbDV1a3E0ZDNpbzRxNW93Y256Z2V6NjRxZjJ3MmppMjF6eSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/DZQTp76MfXhRGOBWok/giphy.gif" alt="Success GIF" style="width: 60%; height: auto;">
    </div>
  </div>

  <script>
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà ‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
    // (‡∏•‡∏≠‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage ‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
    let loans = JSON.parse(localStorage.getItem('loans') || '[]');
    if (loans.length === 0) {
      loans = [
        // === ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥) ===
        {
          name: "‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨",
          principal: 20000,
          rate: 2.0,
          startDate: "2025-08-01", // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î
          repayments: [],
          interestPayments: [],
          unpaidInterestBalance: 0
        },
        {
          name: "‡∏û‡∏¥‡∏á‡∏Å‡∏µ‡πâ",
          principal: 30000,
          rate: 1.8,
          startDate: "2025-07-28", // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î
          repayments: [],
          interestPayments: [],
          unpaidInterestBalance: 0
        },
        {
          name: "‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤",
          principal: 40000,
          rate: 1.5,
          startDate: "2025-07-01",
          repayments: [],
          interestPayments: [{ date: "2025-07-20T10:00:00Z", amount: 600, type: 'full' }], // ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ 20 ‡∏Å.‡∏Ñ.
          unpaidInterestBalance: 0
        },
        // === ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô) ===
        {
          name: "‡∏†‡∏π‡∏ú‡∏≤",
          principal: 10000,
          rate: 2.5,
          startDate: "2025-07-05",
          repayments: [],
          interestPayments: [{ date: "2025-07-10T10:00:00Z", amount: 250, type: 'full' }], // ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ 10 ‡∏Å.‡∏Ñ.
          unpaidInterestBalance: 0
        },
        {
          name: "‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô",
          principal: 18000,
          rate: 2.0,
          startDate: "2025-07-01",
          repayments: [],
          interestPayments: [{ date: "2025-07-15T10:00:00Z", amount: 360, type: 'full' }], // ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ 15 ‡∏Å.‡∏Ñ.
          unpaidInterestBalance: 0
        },
        // === ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô) ===
        {
          name: "‡∏°‡∏∞‡∏•‡∏¥",
          principal: 25000,
          rate: 3.0,
          startDate: "2025-06-01", // ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏¢
          repayments: [],
          interestPayments: [],
          unpaidInterestBalance: 0
        },
        {
          name: "‡πÄ‡∏°‡∏Ü‡∏≤",
          principal: 12000,
          rate: 2.2,
          startDate: "2025-05-15", // ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏¢
          repayments: [],
          interestPayments: [],
          unpaidInterestBalance: 0
        },
        {
          name: "‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤",
          principal: 8000,
          rate: 4.0,
          startDate: "2025-06-25",
          repayments: [],
          interestPayments: [{ date: "2025-07-20T10:00:00Z", amount: 200, type: 'partial' }], // ‡πÄ‡∏Ñ‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÅ‡∏Ñ‡πà‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ 20 ‡∏Å.‡∏Ñ.
          unpaidInterestBalance: 90
        }
      ];
    }

    let currentLoanIndex = -1;
    let accumulatedInterestForPopup = 0; // Global variable to store accumulated interest for the popup

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
    function getTotalPaid(loan) {
      return (loan.repayments || []).reduce((sum, r) => sum + parseFloat(r.amount), 0);
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°
    function getAccumulatedInterest(loan) {
      const now = new Date();
      const totalPaidPrincipal = getTotalPaid(loan);
      let netPrincipal = loan.principal - totalPaidPrincipal;
      if (netPrincipal < 0) netPrincipal = 0;
      
      // *** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏° (startDate) ***
      const startDate = new Date(loan.startDate);
      const startDay = startDate.getDate();
      
      let interestStartPeriod = new Date(now.getFullYear(), now.getMonth(), startDay);
      if (now.getDate() < startDay) {
        interestStartPeriod.setMonth(now.getMonth() - 1);
      }
      
      const lastPaymentDate = loan.interestPayments.length > 0 
          ? new Date(loan.interestPayments[loan.interestPayments.length - 1].date)
          : null;
      
      let baseDate = lastPaymentDate > interestStartPeriod ? lastPaymentDate : interestStartPeriod;
      if (loan.interestPayments.length === 0) {
        baseDate = startDate;
      }
      
      const daysPassed = Math.floor((now - baseDate) / (1000 * 60 * 60 * 24));
      
      const interestPerDay = (netPrincipal * loan.rate / 100) / 30;
      const accumulated = parseFloat(((interestPerDay * daysPassed) + (loan.unpaidInterestBalance || 0)).toFixed(2));
      
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡∏¥‡∏î‡∏•‡∏ö
      return Math.max(0, accumulated);
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢
    function showInterestPopup(index) {
        currentLoanIndex = index;
        const loan = loans[index];
        
        accumulatedInterestForPopup = getAccumulatedInterest(loan);
        
        document.getElementById('interestMessage').textContent = 
          `‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${loan.name} ‡∏Ñ‡∏∑‡∏≠ ${accumulatedInterestForPopup.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
        document.getElementById('interestAmount').value = accumulatedInterestForPopup;
        showPopup('interestPopup');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢
    function submitInterestPayment() {
        const paymentAmount = parseFloat(document.getElementById('interestAmount').value);
        if (isNaN(paymentAmount) || paymentAmount <= 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }
        
        const loan = loans[currentLoanIndex];
        const accumulated = getAccumulatedInterest(loan); // Re-calculate to be sure

        const paymentType = paymentAmount >= accumulated ? 'full' : 'partial';

        if (!loan.interestPayments) loan.interestPayments = [];
        loan.interestPayments.push({ date: new Date().toISOString(), amount: paymentAmount, type: paymentType });
        
        if (paymentType === 'full') {
            loan.unpaidInterestBalance = 0;
        } else {
            loan.unpaidInterestBalance = parseFloat((accumulated - paymentAmount).toFixed(2));
             // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
            alert(`‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°! ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${loan.unpaidInterestBalance.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏ö‡πÑ‡∏õ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`);
        }

        localStorage.setItem('loans', JSON.stringify(loans));
        hidePopup('interestPopup');
        calcSummary();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ
    function calcSummary() {
      const tableBody = document.querySelector('#summaryTable tbody');
      const mobileCardsContainer = document.getElementById('mobileCards');
      const mobileSummary = document.getElementById('mobileSummary');
      if (!tableBody || !mobileCardsContainer || !mobileSummary) return;
      
      tableBody.innerHTML = '';
      mobileCardsContainer.innerHTML = '';
      
      const now = new Date();
      const chartData = [];
      let totalPrincipal = 0, totalAccumulated = 0, totalNextMonth = 0;
      let totalInterestPaidThisMonth = 0;

      loans.forEach((loan, index) => {
        const totalPaid = getTotalPaid(loan);
        let netPrincipal = loan.principal - totalPaid;
        if (netPrincipal < 0) netPrincipal = 0;
        
        const accumulated = getAccumulatedInterest(loan);
        const nextMonth = parseFloat((netPrincipal * loan.rate / 100).toFixed(2));
        
        // *** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏° ***
        const startDate = new Date(loan.startDate);
        const startDay = startDate.getDate();
        
        let nextDueDate = new Date(now.getFullYear(), now.getMonth(), startDay);
        if (now.getDate() > startDay) {
          nextDueDate.setMonth(now.getMonth() + 1);
        }
        
        const daysUntilDue = Math.floor((nextDueDate - now) / (1000 * 60 * 60 * 24));
        const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        
        const hasUnpaidInterest = (loan.unpaidInterestBalance || 0) > 0;
        const isOverdue = daysUntilDue < 0; // ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
        const isCloseToDue = daysUntilDue >= 0 && daysUntilDue <= 5; // ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ß‡∏±‡∏ô)

        let rowClass = '';
        let cardClass = '';

        if (isOverdue) {
            rowClass = 'row-overdue';
            cardClass = 'card-overdue';
        } else if (isCloseToDue) {
            rowClass = 'row-soon-due';
            cardClass = 'card-soon-due';
        } else if (hasUnpaidInterest) {
            rowClass = 'row-partial-paid';
            cardClass = 'card-partial-paid';
        }

        let interestButtonText;
        let interestButtonClass;
        if (hasUnpaidInterest) {
          interestButtonText = '‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏î';
          interestButtonClass = 'btn-partial-paid';
        } else if (accumulated <= 0) {
          interestButtonText = '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
          interestButtonClass = 'btn-paid';
        } else {
          interestButtonText = '‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å';
          interestButtonClass = 'btn-interest';
        }

        totalPrincipal += netPrincipal;
        totalAccumulated += accumulated;
        totalNextMonth += nextMonth;

        // Calculate total interest paid for this month
        loan.interestPayments.forEach(payment => {
          const paymentDate = new Date(payment.date);
          if (paymentDate.getMonth() === now.getMonth() && paymentDate.getFullYear() === now.getFullYear()) {
            totalInterestPaidThisMonth += payment.amount;
          }
        });

        // Populate the summary table (for desktop)
        tableBody.innerHTML += `
          <tr class="${rowClass}">
            <td>${loan.name}</td>
            <td>${netPrincipal.toLocaleString()}</td>
            <td>${loan.rate}%</td>
            <td>${formatDate(loan.startDate)}</td>
            <td>${daysPassed} ‡∏ß‡∏±‡∏ô</td>
            <td class="val-red">${accumulated.toLocaleString()}</td>
            <td>${nextMonth.toLocaleString()}</td>
            <td>${formatDate(nextDueDate)}</td>
            <td><button onclick="showRepaymentPopup(${index})" class="btn-repay">‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</button></td>
            <td><button onclick="showInterestPopup(${index})" class="${interestButtonClass}">${interestButtonText}</button></td>
            <td><button onclick="showHistoryPopup(${index})" class="btn-history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button></td>
            <td><button onclick="showDeletePopup(${index})" class="btn-delete">‡∏•‡∏ö</button></td>
          </tr>`;

        // Create a card for mobile view
        const card = document.createElement('div');
        card.className = `loan-card ${cardClass}`;
        card.innerHTML = `
          <div class="card-header">
            <span class="name">${loan.name}</span>
          </div>
          <div class="card-content">
            <div>
              <span class="card-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
              <span class="card-value">${netPrincipal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div>
              <span class="card-label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°:</span>
              <span class="card-value val-red">${accumulated.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div>
              <span class="card-label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤:</span>
              <span class="card-value">${nextMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div>
              <span class="card-label">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å:</span>
              <span class="card-value">${daysUntilDue} ‡∏ß‡∏±‡∏ô</span>
            </div>
          </div>
          <div class="card-buttons">
            <button onclick="showRepaymentPopup(${index})" class="btn-repay">‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</button>
            <button onclick="showInterestPopup(${index})" class="${interestButtonClass}">${interestButtonText}</button>
            <button onclick="showHistoryPopup(${index})" class="btn-history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            <button onclick="showDeletePopup(${index})" class="btn-delete">‡∏•‡∏ö</button>
          </div>
        `;
        mobileCardsContainer.appendChild(card);
        
        chartData.push({ name: loan.name, remaining: netPrincipal });
      });

      // Populate desktop summary footer
      document.getElementById('summaryFooter').innerHTML =
        `üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <span class="val-gold">${totalPrincipal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span><br>` +
        `üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°: <span class="val-red">${totalAccumulated.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span><br>` +
        `üîÆ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: <span class="val-blue">${totalNextMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span><br>` +
        `üí∏ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span class="val-green">${totalInterestPaidThisMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>`;

      // Populate mobile summary
      mobileSummary.innerHTML =
        `üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <span class="val-gold">${totalPrincipal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span><br>` +
        `üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°: <span class="val-red">${totalAccumulated.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span><br>` +
        `üîÆ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: <span class="val-blue">${totalNextMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span><br>` +
        `üí∏ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span class="val-green">${totalInterestPaidThisMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>`;

      if (chartData.length > 0) updateChart(chartData);
      else if (window.loanChart && typeof window.loanChart.destroy === 'function') window.loanChart.destroy();
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    function updateChart(data) {
      const canvas = document.getElementById('loanChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (window.loanChart && typeof window.loanChart.destroy === 'function') {
        window.loanChart.destroy();
      }
      const maxAmount = Math.max(...data.map(d => d.remaining));
      window.loanChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(l => l.name),
          datasets: [{
            label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)',
            data: data.map(l => l.remaining),
            backgroundColor: data.map(l => `rgba(255, 105, 135, ${Math.max(0.3, l.remaining / maxAmount)})`),
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
    function showRepaymentPopup(index) {
      currentLoanIndex = index;
      const loanName = loans[index].name;
      document.getElementById('repaymentMessage').textContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà ${loanName} ‡∏Ñ‡∏∑‡∏ô:`;
      showPopup('repaymentPopup');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
    function submitRepayment() {
      const amount = document.getElementById('repaymentAmount').value;
      if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (!loans[currentLoanIndex].repayments) loans[currentLoanIndex].repayments = [];
      loans[currentLoanIndex].repayments.push({ amount: parseFloat(amount), date: new Date().toISOString() });
      localStorage.setItem('loans', JSON.stringify(loans));
      hidePopup('repaymentPopup');
      calcSummary();
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    function showDeletePopup(index) {
      currentLoanIndex = index;
      const loanName = loans[index].name;
      document.getElementById('deleteMessage').textContent = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${loanName}?`;
      showPopup('deletePopup');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    function confirmDelete() {
      loans.splice(currentLoanIndex, 1);
      localStorage.setItem('loans', JSON.stringify(loans));
      hidePopup('deletePopup');
      calcSummary();
    }

    // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    function showHistoryPopup(index) {
      const loan = loans[index];
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      
      const allTransactions = [
        ...(loan.repayments || []).map(r => ({ type: '‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô', amount: r.amount, date: new Date(r.date) })),
        ...(loan.interestPayments || []).map(i => ({ type: '‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢', amount: i.amount, date: new Date(i.date), status: i.type })),
      ];

      allTransactions.sort((a, b) => a.date - b.date);

      if (allTransactions.length === 0) {
        historyList.innerHTML = `<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${loan.name}</li>`;
      } else {
        allTransactions.forEach(t => {
          const statusText = t.status === 'partial' ? ' (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)' : t.status === 'full' ? ' (‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)' : '';
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${t.type}${statusText}: ${t.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
            <span class="date">${formatDate(t.date)}</span>
          `;
          historyList.appendChild(li);
        });
      }
      showPopup('historyPopup');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const wsData = [['‡∏ä‡∏∑‡πà‡∏≠', '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤', '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ']];
      const now = new Date();
      loans.forEach(loan => {
        const totalPaid = getTotalPaid(loan);
        const netPrincipal = loan.principal - totalPaid;
        
        const startDate = new Date(loan.startDate);
        const startDay = startDate.getDate();
        let nextDueDate = new Date(now.getFullYear(), now.getMonth(), startDay);
        if (now.getDate() > startDay) {
          nextDueDate.setMonth(now.getMonth() + 1);
        }
        
        const daysPassed = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        const interestPerDay = (netPrincipal * loan.rate / 100) / 30;
        const accumulated = parseFloat(((interestPerDay * daysPassed) + (loan.unpaidInterestBalance || 0)).toFixed(2));
        const nextMonth = (netPrincipal * loan.rate / 100).toFixed(2);
        
        wsData.push([loan.name, netPrincipal, loan.rate + '%', formatDate(loan.startDate), `${daysPassed} ‡∏ß‡∏±‡∏ô`, parseFloat(accumulated), parseFloat(nextMonth), formatDate(nextDueDate)]);
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Loan Summary');
      XLSX.writeFile(wb, 'loan_summary.xlsx');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON
    function uploadData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const newData = JSON.parse(e.target.result);
          if (!Array.isArray(newData)) throw '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          newData.forEach(item => {
            if (typeof item.name !== 'string') throw '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (typeof item.principal !== 'number' || item.principal < 0) throw '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (typeof item.rate !== 'number' || item.rate < 0) throw '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (typeof item.startDate !== 'string' || isNaN(Date.parse(item.startDate))) throw '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (!Array.isArray(item.repayments)) throw '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (!Array.isArray(item.interestPayments)) throw '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
          });
          loans = newData;
          localStorage.setItem('loans', JSON.stringify(loans));
          calcSummary();
          alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } catch (err) {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err);
        }
      };
      reader.readAsText(file);
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ñ‡∏π‡∏Å Submit
    document.getElementById('loanForm').addEventListener('submit', e => {
      e.preventDefault();
      loans.push({
        name: document.getElementById('name').value,
        principal: parseFloat(document.getElementById('principal').value),
        rate: parseFloat(document.getElementById('rate').value),
        startDate: document.getElementById('startDate').value,
        repayments: [],
        interestPayments: [],
        unpaidInterestBalance: 0
      });
      localStorage.setItem('loans', JSON.stringify(loans));
      e.target.reset();
      calcSummary();
      showPopup('successPopup');
      setTimeout(() => {
        hidePopup('successPopup');
      }, 2000);
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Pop-up
    function showPopup(id) {
      const popup = document.getElementById(id);
      if (!popup) return;
      popup.style.display = 'flex';
      requestAnimationFrame(() => popup.classList.add('show'));
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô Pop-up
    function hidePopup(id) {
      const popup = document.getElementById(id);
      if (!popup) return;
      popup.classList.remove('show');
      setTimeout(() => {
        popup.style.display = 'none';
        if (id === 'repaymentPopup') document.getElementById('repaymentAmount').value = '';
      }, 300);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    calcSummary();
  </script>
</body>
</html>
