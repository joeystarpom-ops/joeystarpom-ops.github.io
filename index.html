<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ ‡∏¢‡∏π‡πà‡∏¢‡∏µ‡πà</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
    <!-- ‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background-image: url('https://i.postimg.cc/mr5PY1FR/IMG-2575.jpg'); background-size: cover; background-position: center; background-attachment: fixed; }
        .container { max-width: 950px; margin: 3rem auto; background: rgba(255, 255, 255, 0.85); border-radius: 2rem; padding: 2.5rem; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); animation: fadeIn 1s ease-in-out; }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(30px); } 100% { opacity: 1; transform: translateY(0); } }
        .anim-character { display: block; margin: 20px auto; width: 180px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pop-up */
        .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 99999; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .popup.show { display: flex; opacity: 1; }
        .popup-content { background: #fff; padding: 2rem; border-radius: 1.5rem; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 500px; width: 90%; }
        .popup-content.small { max-width: 350px; padding: 1.5rem; background: transparent; box-shadow: none; }
        .popup-content ul { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; text-align: left; background-color: #fffafc; padding: 1rem; border-radius: 10px; }
        .popup-content li { padding: 0.5rem; border-bottom: 1px solid #f3d6e0; display: flex; justify-content: space-between; align-items: center; }
        .popup-content li:last-child { border-bottom: none; }
        .popup-content li span.date { color: #888; font-size: 0.9rem; }
        .chat-ai { font-style: italic; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ */
        .status-overdue { @apply bg-red-100 border-l-4 border-red-500; }
        .status-partial-paid { @apply bg-purple-100 border-l-4 border-purple-500; }
        .status-soon-due { @apply bg-yellow-100 border-l-4 border-yellow-500; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container text-gray-800">
        <h1 class="text-center text-5xl font-extrabold text-pink-600 mb-6 drop-shadow-lg">
            <span class="animate-pulse">üíñ</span> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ ‡∏¢‡∏π‡πà‡∏¢‡∏µ‡πà
        </h1>
        <div class="chart-wrapper w-full max-w-4xl h-80 mx-auto bg-white rounded-2xl p-6 shadow-xl mb-8">
            <canvas id="loanChart"></canvas>
        </div>
        <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExczdzZWNzbDV1a3E0ZDNpbzRxNW93Y256Z2V6NjRxZjJ3MmppMjF6eSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/DZQTp76MfXhRGOBWok/giphy.gif" class="anim-character" alt="Animated character" />

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà -->
        <form id="loanForm" class="p-6 bg-pink-50 rounded-2xl shadow-inner mb-8">
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="name" class="block font-semibold text-pink-700">‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="text" id="name" required class="mt-1 block w-full rounded-full border-pink-200 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition" />
                </div>
                <div>
                    <label for="principal" class="block font-semibold text-pink-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="principal" required class="mt-1 block w-full rounded-full border-pink-200 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition" />
                </div>
                <div>
                    <label for="rate" class="block font-semibold text-pink-700">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)</label>
                    <input type="number" id="rate" step="0.01" required class="mt-1 block w-full rounded-full border-pink-200 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition" />
                </div>
                <div>
                    <label for="startDate" class="block font-semibold text-pink-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏°</label>
                    <input type="date" id="startDate" required class="mt-1 block w-full rounded-full border-pink-200 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition" />
                </div>
            </div>
            <button type="submit" class="mt-6 w-full py-3 px-6 bg-pink-400 text-white font-bold rounded-full shadow-lg hover:bg-pink-500 transition transform hover:scale-105">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ
            </button>
        </form>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button onclick="downloadExcel()" class="py-3 px-6 bg-purple-400 text-white font-bold rounded-full shadow-lg hover:bg-purple-500 transition transform hover:scale-105">
                üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel
            </button>
            <label for="uploadFile" class="cursor-pointer">
                <input type="file" id="uploadFile" accept=".json" onchange="uploadData(event)" class="hidden" />
                <span class="py-3 px-6 bg-purple-400 text-white font-bold rounded-full shadow-lg hover:bg-purple-500 transition transform hover:scale-105">
                    üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                </span>
            </label>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Desktop) -->
        <div class="hidden md:block bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
            <table id="summaryTable" class="min-w-full divide-y divide-pink-200">
                <thead class="bg-pink-100">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</th>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°</th>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th>
                        <th scope="col" class="px-4 py-3 text-center text-sm font-bold text-pink-800 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody" class="bg-white divide-y divide-pink-100">
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                </tbody>
                <tfoot>
                    <tr class="bg-pink-100">
                        <td colspan="7" id="summaryFooter" class="px-6 py-4 text-left text-lg font-bold text-pink-800">
                            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
        <div id="mobileCards" class="md:hidden flex flex-col space-y-4 mb-8">
            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
        <div id="mobileSummary" class="md:hidden p-4 bg-pink-100 rounded-2xl font-bold text-pink-800 shadow-md mb-8">
            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI -->
        <div class="chat-section p-6 bg-white rounded-2xl shadow-xl">
            <div class="text-2xl font-bold text-pink-700 mb-4 flex items-center">
                <span class="mr-2">ü§ñ</span> ‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI
            </div>
            <div id="chatBox" class="h-64 overflow-y-auto p-4 border border-pink-200 bg-pink-50 rounded-xl flex flex-col space-y-4 mb-4">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
            <div class="flex space-x-2">
                <input type="text" id="chatInput" placeholder="‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ..." class="flex-grow rounded-full border-pink-200 shadow-sm focus:border-pink-500 focus:ring-pink-500 transition" />
                <button onclick="sendMessage()" class="py-2 px-6 bg-pink-400 text-white font-bold rounded-full shadow-lg hover:bg-pink-500 transition transform hover:scale-105">
                    ‡∏™‡πà‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Pop-up Templates -->
    <div class="popup" id="repaymentPopup">
        <div class="popup-content">
            <h3 class="text-2xl font-bold text-pink-600 mb-4">‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</h3>
            <p id="repaymentMessage" class="mb-4 text-gray-600"></p>
            <input type="number" id="repaymentAmount" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" class="mb-4 w-full p-2 rounded-lg border border-gray-300" />
            <div class="flex justify-center gap-2">
                <button onclick="submitRepayment()" class="bg-pink-400 shadow-md hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button onclick="hidePopup('repaymentPopup')" class="bg-gray-400 shadow-md hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div class="popup" id="interestPopup">
        <div class="popup-content">
            <h3 class="text-2xl font-bold text-pink-600 mb-4">‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</h3>
            <p id="interestMessage" class="mb-4 text-gray-600"></p>
            <input type="number" id="interestAmount" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)" class="mb-4 w-full p-2 rounded-lg border border-gray-300" />
            <div class="flex justify-center gap-2">
                <button onclick="submitInterestPayment()" class="bg-pink-400 shadow-md hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button onclick="hidePopup('interestPopup')" class="bg-gray-400 shadow-md hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div class="popup" id="deletePopup">
        <div class="popup-content">
            <h3 class="text-2xl font-bold text-red-600 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p id="deleteMessage" class="mb-4 text-gray-600"></p>
            <div class="flex justify-center gap-2">
                <button onclick="confirmDelete()" class="bg-red-500 shadow-md hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button onclick="hidePopup('deletePopup')" class="bg-gray-400 shadow-md hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div class="popup" id="historyPopup">
        <div class="popup-content">
            <h3 class="text-2xl font-bold text-pink-600 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <ul id="historyList" class="p-4 bg-gray-50 rounded-lg"></ul>
            <div class="flex justify-center gap-2 mt-4">
                <button onclick="hidePopup('historyPopup')" class="bg-pink-400 shadow-md hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div class="popup" id="messagePopup">
        <div class="popup-content small">
            <div id="messageText" class="text-center font-bold text-lg text-pink-700"></div>
            <img id="messageGif" src="" alt="Popup GIF" class="w-full h-auto mt-4 rounded-lg" style="display: none;">
            <div class="flex justify-center gap-2 mt-4">
                <button onclick="hidePopup('messagePopup')" class="bg-pink-400 shadow-md hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-full">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>
    
    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤ localStorage ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        let loans = JSON.parse(localStorage.getItem('loans')) || [
            { name: "‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨", principal: 20000, rate: 2.0, startDate: "2025-08-01", repayments: [], interestPayments: [], unpaidInterestBalance: 0 },
            { name: "‡∏û‡∏¥‡∏á‡∏Å‡∏µ‡πâ", principal: 30000, rate: 1.8, startDate: "2025-07-28", repayments: [], interestPayments: [], unpaidInterestBalance: 0 },
            { name: "‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏•‡πâ‡∏≤", principal: 40000, rate: 1.5, startDate: "2025-07-20", repayments: [], interestPayments: [{ date: "2025-07-20T10:00:00Z", amount: 600, type: 'full' }], unpaidInterestBalance: 0 },
            { name: "‡∏†‡∏π‡∏ú‡∏≤", principal: 10000, rate: 2.5, startDate: "2025-07-10", repayments: [], interestPayments: [{ date: "2025-07-10T10:00:00Z", amount: 250, type: 'full' }], unpaidInterestBalance: 0 },
            { name: "‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô", principal: 18000, rate: 2.0, startDate: "2025-07-15", repayments: [], interestPayments: [{ date: "2025-07-15T10:00:00Z", amount: 360, type: 'full' }], unpaidInterestBalance: 0 },
            { name: "‡∏°‡∏∞‡∏•‡∏¥", principal: 25000, rate: 3.0, startDate: "2025-06-01", repayments: [], interestPayments: [], unpaidInterestBalance: 0 },
            { name: "‡πÄ‡∏°‡∏Ü‡∏≤", principal: 12000, rate: 2.2, startDate: "2025-05-15", repayments: [], interestPayments: [], unpaidInterestBalance: 0 },
            { name: "‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤", principal: 8000, rate: 4.0, startDate: "2025-06-25", repayments: [], interestPayments: [{ date: "2025-07-20T10:00:00Z", amount: 200, type: 'partial' }], unpaidInterestBalance: 90 }
        ];

        let currentLoanIndex = -1;
        const successGif = "https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExMGVzMHFqZmVtMW5wZDJ3bjh1cm8xZXhkeGk2c2lxM2Jtc3hxbmFyaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/oDatDPoi5nTy2Ypcrw/giphy.gif";

        // === ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• UI ===

        // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞ GIF
        function showMessagePopup(message, gifUrl = '') {
            const popup = document.getElementById('messagePopup');
            const messageText = document.getElementById('messageText');
            const messageGif = document.getElementById('messageGif');
            messageText.textContent = message;
            messageGif.src = gifUrl;
            messageGif.style.display = gifUrl ? 'block' : 'none';
            showPopup('messagePopup');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // ‡πÅ‡∏™‡∏î‡∏á Pop-up
        function showPopup(id) {
            document.getElementById(id).classList.add('show');
        }

        // ‡∏ã‡πà‡∏≠‡∏ô Pop-up
        function hidePopup(id) {
            document.getElementById(id).classList.remove('show');
        }

        // === ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ===

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function getTotalPaid(loan) {
            return (loan.repayments || []).reduce((sum, r) => sum + parseFloat(r.amount), 0);
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°
        function getAccumulatedInterest(loan) {
            const now = new Date();
            const totalPaidPrincipal = getTotalPaid(loan);
            let netPrincipal = loan.principal - totalPaidPrincipal;
            if (netPrincipal < 0) netPrincipal = 0;

            const lastInterestPayment = loan.interestPayments.length > 0
                ? loan.interestPayments[loan.interestPayments.length - 1]
                : null;
            
            const lastInterestPaidDate = lastInterestPayment
                ? new Date(lastInterestPayment.date)
                : new Date(loan.startDate);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏°
            const daysPassed = Math.floor((now - lastInterestPaidDate) / (1000 * 60 * 60 * 24));
            const interestPerDay = (netPrincipal * loan.rate / 100) / 30;
            const newInterest = interestPerDay * daysPassed;

            // ‡∏ô‡∏≥‡∏¢‡∏≠‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢
            const accumulated = parseFloat((newInterest + (loan.unpaidInterestBalance || 0)).toFixed(2));
            return accumulated;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function calcSummary() {
            const tableBody = document.getElementById('summaryTableBody');
            const mobileCardsContainer = document.getElementById('mobileCards');
            const mobileSummary = document.getElementById('mobileSummary');
            if (!tableBody || !mobileCardsContainer || !mobileSummary) return;
            
            tableBody.innerHTML = '';
            mobileCardsContainer.innerHTML = '';
            
            const now = new Date();
            const chartData = [];
            let totalPrincipal = 0, totalAccumulated = 0, totalNextMonth = 0;

            loans.forEach((loan, index) => {
                const totalPaid = getTotalPaid(loan);
                let netPrincipal = loan.principal - totalPaid;
                if (netPrincipal < 0) netPrincipal = 0;
                
                const accumulated = getAccumulatedInterest(loan);
                const nextMonth = parseFloat((netPrincipal * loan.rate / 100).toFixed(2));
                
                const lastInterestPayment = loan.interestPayments.length > 0
                    ? loan.interestPayments[loan.interestPayments.length - 1]
                    : null;
                
                const lastInterestPaidDate = lastInterestPayment
                    ? new Date(lastInterestPayment.date)
                    : new Date(loan.startDate);
                
                const daysPassed = Math.floor((now - lastInterestPaidDate) / (1000 * 60 * 60 * 24));
                const nextDueDate = new Date(lastInterestPaidDate);
                nextDueDate.setMonth(lastInterestPaidDate.getMonth() + 1);

                const hasUnpaidInterest = (loan.unpaidInterestBalance || 0) > 0;
                const isOverdue = daysPassed > 30 && !hasUnpaidInterest;
                const isPartialPaid = hasUnpaidInterest;
                const isCloseToDue = daysPassed >= 25 && daysPassed <= 30 && !isOverdue && !isPartialPaid;

                let rowClass = '';
                if (isOverdue) rowClass = 'status-overdue';
                else if (isPartialPaid) rowClass = 'status-partial-paid';
                else if (isCloseToDue) rowClass = 'status-soon-due';
                
                const interestButtonText = accumulated <= 0 ? '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å';
                const interestButtonClass = accumulated <= 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-pink-400 hover:bg-pink-500';

                totalPrincipal += netPrincipal;
                totalAccumulated += accumulated;
                totalNextMonth += nextMonth;

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Desktop)
                const tableRow = document.createElement('tr');
                tableRow.className = `transition hover:bg-pink-50 ${rowClass}`;
                tableRow.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-center">${loan.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">${netPrincipal.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">${loan.rate}%</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">${formatDate(loan.startDate)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center text-red-500 font-bold">${accumulated.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">${formatDate(nextDueDate)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <div class="flex justify-center space-x-2">
                            <button onclick="showRepaymentPopup(${index})" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-1 px-3 rounded-full text-xs transition">
                                ‚ûï ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô
                            </button>
                            <button onclick="showInterestPopup(${index})" class="${interestButtonClass} text-white font-bold py-1 px-3 rounded-full text-xs transition" ${accumulated <= 0 ? 'disabled' : ''}>
                                ${interestButtonText}
                            </button>
                            <button onclick="showHistoryPopup(${index})" class="bg-purple-400 hover:bg-purple-500 text-white font-bold py-1 px-3 rounded-full text-xs transition">
                                ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                            </button>
                            <button onclick="showDeletePopup(${index})" class="bg-red-400 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-full text-xs transition">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tableRow);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
                const card = document.createElement('div');
                card.className = `p-4 bg-white rounded-2xl shadow-lg transition transform hover:scale-105 ${rowClass}`;
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xl font-bold text-pink-700 truncate">${loan.name}</span>
                        <div class="flex space-x-2">
                            <button onclick="showRepaymentPopup(${index})" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-1 px-2 rounded-full text-xs">‚ûï</button>
                            <button onclick="showInterestPopup(${index})" class="${interestButtonClass} text-white font-bold py-1 px-2 rounded-full text-xs" ${accumulated <= 0 ? 'disabled' : ''}>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</button>
                            <button onclick="showHistoryPopup(${index})" class="bg-purple-400 hover:bg-purple-500 text-white font-bold py-1 px-2 rounded-full text-xs">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                            <button onclick="showDeletePopup(${index})" class="bg-red-400 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full text-xs">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm py-1 border-b border-gray-200">
                        <span class="font-semibold text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                        <span class="font-bold">${netPrincipal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="flex justify-between text-sm py-1 border-b border-gray-200">
                        <span class="font-semibold text-gray-600">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°:</span>
                        <span class="font-bold text-red-500">${accumulated.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="flex justify-between text-sm py-1 border-b border-gray-200">
                        <span class="font-semibold text-gray-600">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</span>
                        <span class="font-bold">${formatDate(nextDueDate)}</span>
                    </div>
                `;
                mobileCardsContainer.appendChild(card);
                
                chartData.push({ name: loan.name, remaining: netPrincipal });
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Desktop)
            document.getElementById('summaryFooter').innerHTML = `
                <span class="mr-6">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <span class="font-extrabold text-blue-600">${totalPrincipal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></span>
                <span class="mr-6">üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°: <span class="font-extrabold text-green-600">${totalAccumulated.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></span>
                <span>üîÆ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: <span class="font-extrabold text-pink-600">${totalNextMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></span>
            `;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Mobile)
            mobileSummary.innerHTML = `
                <div class="mb-2">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°: <span class="font-extrabold text-blue-600">${totalPrincipal.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></div>
                <div class="mb-2">üìà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°: <span class="font-extrabold text-green-600">${totalAccumulated.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></div>
                <div>üîÆ ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: <span class="font-extrabold text-pink-600">${totalNextMonth.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span></div>
            `;

            if (chartData.length > 0) updateChart(chartData);
            else if (window.loanChart && typeof window.loanChart.destroy === 'function') window.loanChart.destroy();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        function updateChart(data) {
            const canvas = document.getElementById('loanChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (window.loanChart && typeof window.loanChart.destroy === 'function') {
                window.loanChart.destroy();
            }
            const maxAmount = Math.max(...data.map(d => d.remaining)) * 1.1; // Add 10% buffer for better visualization
            window.loanChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(l => l.name),
                    datasets: [{
                        label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ö‡∏≤‡∏ó)',
                        data: data.map(l => l.remaining),
                        backgroundColor: data.map(l => `rgba(255, 105, 135, ${Math.max(0.3, l.remaining / maxAmount)})`),
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: maxAmount },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // === ‡∏™‡πà‡∏ß‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Form ‡πÅ‡∏•‡∏∞ Pop-up Actions ===

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ submit form ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà
        function addLoan(event) {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const principal = parseFloat(document.getElementById('principal').value);
            const rate = parseFloat(document.getElementById('rate').value);
            const startDate = document.getElementById('startDate').value;
            
            if (!name || isNaN(principal) || principal <= 0 || isNaN(rate) || rate < 0 || !startDate) {
                showMessagePopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const newLoan = {
                name,
                principal,
                rate,
                startDate,
                repayments: [],
                interestPayments: [],
                unpaidInterestBalance: 0
            };
            
            loans.push(newLoan);
            localStorage.setItem('loans', JSON.stringify(loans));
            calcSummary();
            document.getElementById('loanForm').reset();
            showMessagePopup('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!', successGif);
        }

        // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
        function showRepaymentPopup(index) {
            currentLoanIndex = index;
            const loanName = loans[index].name;
            document.getElementById('repaymentMessage').textContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà ${loanName} ‡∏Ñ‡∏∑‡∏ô:`;
            showPopup('repaymentPopup');
        }

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
        function submitRepayment() {
            const amount = document.getElementById('repaymentAmount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                showMessagePopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            if (!loans[currentLoanIndex].repayments) loans[currentLoanIndex].repayments = [];
            loans[currentLoanIndex].repayments.push({ amount: parseFloat(amount), date: new Date().toISOString() });
            localStorage.setItem('loans', JSON.stringify(loans));
            hidePopup('repaymentPopup');
            showMessagePopup('‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!', successGif);
            calcSummary();
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢
        function showInterestPopup(index) {
            currentLoanIndex = index;
            const loan = loans[index];
            const accumulatedInterest = getAccumulatedInterest(loan);
            
            document.getElementById('interestMessage').textContent =
                `‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${loan.name} ‡∏Ñ‡∏∑‡∏≠ ${accumulatedInterest.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('interestAmount').value = accumulatedInterest;
            showPopup('interestPopup');
        }

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢
        function submitInterestPayment() {
            const paymentAmount = parseFloat(document.getElementById('interestAmount').value);
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                showMessagePopup('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            const loan = loans[currentLoanIndex];
            const accumulated = getAccumulatedInterest(loan);
            const paymentType = paymentAmount >= accumulated ? 'full' : 'partial';

            if (!loan.interestPayments) loan.interestPayments = [];
            loan.interestPayments.push({ date: new Date().toISOString(), amount: paymentAmount, type: paymentType });
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
            if (paymentType === 'full') {
                loan.unpaidInterestBalance = 0;
            } else {
                loan.unpaidInterestBalance = parseFloat((accumulated - paymentAmount).toFixed(2));
            }

            localStorage.setItem('loans', JSON.stringify(loans));
            hidePopup('interestPopup');
            showMessagePopup('‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!', successGif);
            calcSummary();
        }

        // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        function showDeletePopup(index) {
            currentLoanIndex = index;
            const loanName = loans[index].name;
            document.getElementById('deleteMessage').textContent = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ${loanName}?`;
            showPopup('deletePopup');
        }

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        function confirmDelete() {
            loans.splice(currentLoanIndex, 1);
            localStorage.setItem('loans', JSON.stringify(loans));
            hidePopup('deletePopup');
            showMessagePopup('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!', successGif);
            calcSummary();
        }

        // ‡πÅ‡∏™‡∏î‡∏á Pop-up ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        function showHistoryPopup(index) {
            const loan = loans[index];
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const allTransactions = [
                ...(loan.repayments || []).map(r => ({ type: '‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô', amount: r.amount, date: new Date(r.date) })),
                ...(loan.interestPayments || []).map(i => ({ type: '‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢', amount: i.amount, date: new Date(i.date), status: i.type })),
            ];

            allTransactions.sort((a, b) => a.date - b.date);

            if (allTransactions.length === 0) {
                historyList.innerHTML = `<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${loan.name}</li>`;
            } else {
                allTransactions.forEach(t => {
                    const statusText = t.status === 'partial' ? ' (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)' : t.status === 'full' ? ' (‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)' : '';
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${t.type}${statusText}: ${t.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                        <span class="date">${formatDate(t.date)}</span>
                    `;
                    historyList.appendChild(li);
                });
            }
            showPopup('historyPopup');
        }

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [['‡∏ä‡∏∑‡πà‡∏≠', '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏∞‡∏™‡∏°', '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ']];
            loans.forEach(loan => {
                const totalPaid = getTotalPaid(loan);
                const netPrincipal = loan.principal - totalPaid;
                const accumulated = getAccumulatedInterest(loan);
                const lastInterestPayment = loan.interestPayments.length > 0 ? loan.interestPayments[loan.interestPayments.length - 1] : null;
                const lastInterestPaidDate = lastInterestPayment ? new Date(lastInterestPayment.date) : new Date(loan.startDate);
                const nextDueDate = new Date(lastInterestPaidDate);
                nextDueDate.setMonth(lastInterestPaidDate.getMonth() + 1);
                wsData.push([loan.name, netPrincipal, loan.rate + '%', formatDate(loan.startDate), parseFloat(accumulated), formatDate(nextDueDate)]);
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Loan Summary');
            XLSX.writeFile(wb, 'loan_summary.xlsx');
            showMessagePopup('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö!', successGif);
        }

        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON
        function uploadData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const newData = JSON.parse(e.target.result);
                    if (!Array.isArray(newData)) throw '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    loans = newData;
                    localStorage.setItem('loans', JSON.stringify(loans));
                    calcSummary();
                    showMessagePopup('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', successGif);
                } catch (error) {
                    showMessagePopup(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error}`);
                }
            };
            reader.readAsText(file);
        }

        // === ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á AI Chat ===
        let chatHistory = [];
        const chatBox = document.getElementById('chatBox');
        const chatInput = document.getElementById('chatInput');

        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            appendMessage(userMessage, 'user');
            chatInput.value = '';

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            const loadingIndicator = appendMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...', 'ai', true);

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            const payload = {
                contents: chatHistory,
            };
            const apiKey = ""; // API key ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏´‡∏≤‡πÇ‡∏î‡∏¢ Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å API
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    updateMessage(loadingIndicator, aiResponse);
                } else {
                    updateMessage(loadingIndicator, "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                updateMessage(loadingIndicator, "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡πÑ‡∏î‡πâ");
            }
        }
        
        function appendMessage(text, sender, isLoading = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender === 'user' ? 'chat-user' : 'chat-ai');
            messageElement.textContent = text;
            if (isLoading) {
                messageElement.classList.add('loading-indicator');
            }
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
            return messageElement;
        }

        function updateMessage(element, text) {
            element.textContent = text;
            element.classList.remove('loading-indicator');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Exponential Backoff ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ API Throttling
        async function fetchWithExponentialBackoff(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // 429 Too Many Requests
                        return response;
                    }
                } catch (error) {
                    // Log error but don't rethrow yet
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                }
                await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
            }
            throw new Error('All fetch retries failed.');
        }

        // === ‡∏™‡πà‡∏ß‡∏ô Event Listeners ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ===
        document.getElementById('loanForm').addEventListener('submit', addLoan);
        
        window.onload = () => {
            calcSummary();
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
        };
    </script>
</body>
</html>
